<!DOCTYPE html>
<!-- 1. 레이아웃 파일 지정 및 네임스페이스 확인 -->
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout/defaultLayout}">

<body>
<!-- 3. layout:fragment="content" 영역 정의 및 실제 콘텐츠 이동 -->
<div layout:fragment="content">
  <!-- ========== title-wrapper start ========== -->
  <div class="title-wrapper pt-30">
    <div class="row align-items-center">
      <div class="col-md-6">
        <div class="title">
          <h2>광고자동화 - META</h2>
        </div>
      </div>

      <form enctype="multipart/form-data">

            <div class="menu-toggle-btn mr-15">
              <button type="button" id="uploadButton" >Upload</button>
              <input type="file" name="file" id="excelInput" accept=".xlsx, .xlsm, .xlsb, .xltx">
            </div>

      </form>









      <!-- end col -->
      <div class="col-md-12">
        <div class="breadcrumb-wrapper">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item">
                <!-- Thymeleaf URL 사용 (href="#0" -> th:href="@{/index.html} 또는 적절한 경로) -->
                <a th:href="@{/index}">대시보드</a>
              </li>
              <li class="breadcrumb-item active" aria-current="page">
                광고자동화 / Meta
              </li>
            </ol>
          </nav>
        </div>
      </div>
      <!-- end col -->
    </div>
    <!-- end row -->
  </div>
  <!-- ========== title-wrapper end ========== -->

  <!-- ========== tables-wrapper start ========== -->
  <div id="myGrid" style="width: 100%; height: 500px">

    <!-- end row -->

  <!-- ========== tables-wrapper end ========== -->


</div> <!-- layout:fragment="content" 끝 -->

<!-- 6. 페이지별 스크립트가 필요하면 여기에 추가 -->
<th:block layout:fragment="script">
<script>
  let minRowHeight = 150;
  let currentRowHeight;
  let gridApi;

  function FileUpload(e) {
    /*비번 ehdydgkwlak!2
    리스트 형태
    adAccountList
    adAccountName

    campaignList
    campaignName
    campaignResolved

    pixelList
    pixelResolved

    setList
    setName
    setResolved*/
    console.log(e);

    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];

    if (!file) {
      return; // 파일이 선택되지 않았을 경우 함수 종료
    }

    const formData = new FormData();
    formData.append('files', file);
    formData.append('request', row);//여기에 해당 row event.eGui.parentElement.parentElement를 넣어야할지.
    fetch('/api/meta/publish', { // 서버 업로드 엔드포인트
      method: 'POST',
      body: formData,
    })
            .then(response => response.json())
            .then(data => {
              console.log('Upload success:', data);
            })
            .catch(error => {
              console.error('Upload error:', error);
            });
  }

  class CustomButtonComponent {
    eGui;
    eButton;
    eventListener;

    init() {
      this.eGui = document.createElement("div");
      const eButton = document.createElement("input");
      eButton.setAttribute("type", "file");
      eButton.setAttribute("name", "files");
      //eButton.className = "primary-btn btn-hover simple-btn";
      eButton.textContent = "파일 업로드";
      //this.eventListener = () => FileUpload(this.eGui);// 파일업로드 올리기
      eButton.addEventListener("click", this.eventListener);
      this.eGui.appendChild(eButton);
    }

    getGui() {
      return this.eGui;
    }

    refresh() {
      return true;
    }

    destroy() {
      if (this.eButton) {
        this.eButton.removeEventListener("click", this.eventListener);
      }
    }
  }

  const gridOptions = {

    rowData: [],

    columnDefs: [
      {
        headerName: "파일 업로드",
        field: "button",
        cellRenderer: CustomButtonComponent,
        flex: 1,
        minWidth: 100
      },
      {
        headerName: "캠페인 목표(선택)",
        field: "metaCampaignObjective",
        editable: true,
        flex: 1,
        cellEditor: "agSelectCellEditor",
        cellEditorParams: {
          values: [
            "판매",
            "트래픽"

          ],
        },
        minWidth: 150, maxWidth: 300
      },
      {
        headerName: "광고 계정명",
        field: "adAccountName",
        editable: true,
        flex: 1,
        minWidth: 150, maxWidth: 300
      },
      {
        headerName: "캠페인 형태(선택)",
        field: "metaCampaignType",
        editable: true,
        flex: 1,
        cellEditor: "agSelectCellEditor",
        cellEditorParams: {
          values: [
            "ABO",
            "ASC",
            "CBO",
          ],
        },
        minWidth: 150, maxWidth: 300
      },
      {
        headerName: "캠페인명",
        field: "campaignName",
        editable: true,
        flex: 1,
        minWidth: 150, maxWidth: 300
      },
      {
        headerName: "예산",
        field: "budget",
        editable: true,
        flex: 1,
        minWidth: 150, maxWidth: 300
      },
      {
        headerName: "시작날짜",
        field: "startDate",
        editable: true,
        flex: 1,
        minWidth: 150, maxWidth: 300
      },
      {
        headerName: "시작 시간",
        field: "startTime",
        editable: true,
        flex: 1,
        minWidth: 150, maxWidth: 300
      },
      {
        headerName: "위치",
        field: "location",
        editable: true,
        flex: 1,
        minWidth: 150, maxWidth: 300
      },
      {
        headerName: "언어",
        field: "language",
        editable: true,
        flex: 1,
        minWidth: 100, maxWidth: 300
      },
      {
        headerName: "성별",
        field: "gender",
        editable: true,
        flex: 1,
        minWidth: 100, maxWidth: 300
      },
      {
        headerName: "최소 연령",
        field: "minAge",
        editable: true,
        flex: 1,
        minWidth: 100, maxWidth: 300
      },
      {
        headerName: "최대 연령",
        field: "maxAge",
        editable: true,
        flex: 1,
        minWidth: 100, maxWidth: 300
      },
      {
        headerName: "세트명",
        field: "setName",
        editable: true,
        flex: 1,
        minWidth: 150, maxWidth: 300
      },
      {
        headerName: "광고소재명",
        field: "adMaterialName",
        editable: true,
        flex: 1,
        minWidth: 150, maxWidth: 300
      },
      {
        headerName: "업로드 페이지명",
        field: "uploadPage",
        editable: true,
        flex: 1,
        minWidth: 150, maxWidth: 300
      },
      {
        headerName: "형식(선택)",
        field: "metaCreativeFormat",
        editable: true,
        flex: 1,
        cellEditor: "agSelectCellEditor",
        cellEditorParams: {
          values: [
            "단일 이미지·동영상",
            "슬라이드",

          ],
        },
        minWidth: 150, maxWidth: 300
      },
      {
        headerName: "랜딩페이지 URL",
        field: "landingUrl",
        editable: true,
        flex: 1,
        minWidth: 150, maxWidth: 300
      },
      {
        headerName: "표시링크 URL",
        field: "displayUrl",
        editable: true,
        flex: 1,
        minWidth: 100, maxWidth: 300
      },
      {
        headerName: "기본 문구",
        field: "defaultText",
        editable: true,
        flex: 1,
        minWidth: 100, maxWidth: 300
      },
      {
        headerName: "제목",
        field: "title",
        editable: true,
        flex: 1,
        minWidth: 100, maxWidth: 300
      },
      {
        headerName: "설명",
        field: "description",
        editable: true,
        flex: 1,
        minWidth: 100, maxWidth: 300
      },
      {
        headerName: "기타 요청사항",
        field: "otherRequests",
        editable: true,
        flex: 1,
        minWidth: 100, maxWidth: 300
      },
    ],

    rowClassRules: {
      // apply red to Ford cars
      "rag-green": (params) => params.data.agSelectCellEditor === "ASC",
    },
    /*rowData: getData(), 이거로 불러서 데이터 뿌려주기*/
    autoSizeStrategy: {
      type: "fitGridWidth",
    },
    onGridReady: (params) => {
      minRowHeight = params.api.getSizesForCurrentTheme().rowHeight;
      currentRowHeight = minRowHeight;
    },

    getRowHeight: (params) => {
      return currentRowHeight;
    },
  };

  let excelData =[];//확인용
  document.addEventListener("DOMContentLoaded", function () {
    const gridDiv = document.querySelector("#myGrid");
    // gridApi를 여기서 초기화합니다.
    gridApi = agGrid.createGrid(gridDiv, gridOptions);

    const Input = document.getElementById('excelInput');
    const uploadButton = document.getElementById('uploadButton');
    let selectedFile;

    Input.addEventListener('change', function (event) {
      selectedFile = event.target.files[0];
      // (선택 사항) 파일이 선택되면 버튼 활성화 등의 로직 추가 가능
      if(selectedFile) {
        console.log("파일 선택됨:", selectedFile.name);
        // uploadButton.disabled = false; // 예시: 버튼 활성화
      }
    });

    // 업로드 버튼 클릭 시 실행될 로직
    uploadButton.addEventListener('click', function() {
      // 파일이 선택되었는지 확인
      if (!selectedFile) {
        alert('업로드할 엑셀 파일을 먼저 선택해주세요.');
        return;
      }

      const formData = new FormData();
      formData.append('file', selectedFile);

      const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
      let headerValues = {};
      if (csrfHeader && csrfToken) {
        headerValues[csrfHeader] = csrfToken;
      }

      console.log("파일 업로드 시작...");
      gridApi.showLoadingOverlay();

      fetch('/api/meta/upload', {
        headers: headerValues,
        method: 'POST',
        body: formData
      })
              .then(response => {
                if (!response.ok) {
                  // 서버 응답이 실패(4xx, 5xx)했을 경우 에러 처리
                  throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json(); // JSON 파싱
              })
              .then(resData => {
                // 서버로부터 받은 데이터로 그리드 업데이트
                console.log("업로드 성공 및 데이터 수신:", resData);
                if (gridApi && resData) {
                  excelData = resData;
                  gridApi.setGridOption('rowData', resData.data);

                } else {
                  console.warn("gridApi가 초기화되지 않았거나 받은 데이터가 없습니다.");
                }

                gridApi.hideOverlay();
              })
              .catch(error => {
                // 에러 처리
                console.error("파일 업로드 또는 처리 중 에러 발생:", error);
                alert(`파일 업로드 중 오류가 발생했습니다: ${error.message}`);
                gridApi.hideOverlay();
              });
    });
  }); // DOMContentLoaded listener 끝
</script>

</th:block>

</body>

</html>
