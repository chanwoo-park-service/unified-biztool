<!DOCTYPE html>
<!-- 1. 레이아웃 파일 지정 및 네임스페이스 확인 -->
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout/defaultLayout}">

<body>
<!-- 3. layout:fragment="content" 영역 정의 및 실제 콘텐츠 이동 -->
<div layout:fragment="content">
  <!-- ========== title-wrapper start ========== -->
  <div class="title-wrapper pt-30">
    <div class="row align-items-center">
      <div class="col-md-6">
        <div class="title">
          <h2>광고자동화 - META</h2>
        </div>
      </div>
      <!-- end col -->
      <div class="col-md-12">
        <div class="breadcrumb-wrapper">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item">
                <!-- Thymeleaf URL 사용 (href="#0" -> th:href="@{/index.html} 또는 적절한 경로) -->
                <a th:href="@{/}">대시보드</a>
              </li>
              <li class="breadcrumb-item active" aria-current="page">
                광고자동화 / Meta
              </li>
            </ol>
          </nav>
        </div>
      </div>

      <form enctype="multipart/form-data">
        <div class="menu-toggle-btn mr-15 d-flex align-items-center">
          <button type="button" class="btn btn-primary me-2" id="uploadButton">엑셀 업로드</button> <!-- me-2: 오른쪽 마진 추가 -->
          <input type="file" class="form-control" style="width: 50%" name="file" id="excelInput" accept=".xlsx, .xlsm, .xlsb, .xltx" >
          <!--          <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#exampleModal">Open modal</button>-->
          <button type="button" class="btn btn-danger ms-auto" th:onclick="openModeal()">광고 등록</button>
        </div>
        <!-- </form> -->
      </form>
      <!-- end col -->
    </div>
    <!-- end row -->
  </div>
  <!-- ========== title-wrapper end ========== -->

  <!-- ========== tables-wrapper start ========== -->
  <div id="myGrid" style="width: 100%; height: 500px; margin-top: 20px;">

    <!-- end row -->

    <!-- ========== tables-wrapper end ========== -->

    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">선택창</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="container">
              <div class="row">
                <div class="row mb-3">
                  <div class="col-md-3"><label class="form-label">광고 계정 목록</label></div>
                  <div class="col-md-3"><label class="form-label">캠페인 목록</label></div>
                  <div class="col-md-3"><label class="form-label">픽셀 목록</label></div>
                  <div class="col-md-3"><label class="form-label">세트 목록</label></div>
                </div>
              </div>
              <div class="row" id="selectData">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" onclick="metaSubmit()" class="btn btn-primary">META 전송</button>
          </div>
        </div>
      </div>
    </div>


    <!-- ========== 오류 메시지 표시용 모달 추가 ========== -->
    <div class="modal fade" id="errorDetailModal" tabindex="-1" aria-labelledby="errorDetailModalLabel" aria-hidden="true">
      <!-- modal-dialog-scrollable 및 modal-lg 클래스 추가 -->
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="errorDetailModalLabel">오류 상세 내용</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="errorDetailModalBody">
            <!-- 오류 메시지가 여기에 표시됩니다 -->
            <pre style="white-space: pre-wrap; word-wrap: break-word;"><code><!-- 스타일 추가: 자동 줄바꿈 -->
            </code></pre>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
          </div>
        </div>
      </div>
    </div>
    <!-- ========== 오류 메시지 모달 끝 ========== -->

  </div> <!-- layout:fragment="content" 끝 -->


  <!-- 6. 페이지별 스크립트가 필요하면 여기에 추가 -->
  <script>
    window.addEventListener('beforeunload', function (e) {
      // 취소 메시지 설정 (브라우저마다 다르게 표시될 수 있음)
      const confirmationMessage = '변경사항이 저장되지 않을 수 있습니다. 정말 페이지를 떠나시겠습니까?';

      // 표준 방식 (대부분의 브라우저)
      e.preventDefault();

      // 이전 방식 (이전 브라우저 호환성)
      (e || window.event).returnValue = confirmationMessage;

      // 일부 브라우저에서는 반환 값도 필요
      return confirmationMessage;
    });

    let minRowHeight = 150;
    let currentRowHeight;
    let gridApi;
    let selectData = document.getElementById('selectData');
    function openModeal(){
      selectData.innerHTML = ''; // modal 초기화
      const rowDataArray = gridApi.getGridOption('rowData'); // 배열 가져오기

      if (!rowDataArray || rowDataArray.length === 0) {
        alert("엑셀 데이터를 먼저 업로드하고 그리드를 채워주세요.");
        return; // 데이터 없으면 모달 열지 않음
      }

      // forEach 루프에서 index 파라미터 사용
      rowDataArray.forEach((rowData, index) => { // <<<--- rowData와 index 받기

        // 각 행의 리스트 가져오기
        const currentAdAccountList = rowData.adAccountList || [];
        const currentCampaignList = rowData.campaignList || [];
        const currentPixelList = rowData.pixelList || [];
        const currentSetList = rowData.setList || [];

        // HTML 생성 시 index 사용
        selectData.innerHTML +=
                '<div class="row mb-2">' // 각 행 사이에 약간의 마진 추가 (선택적)
                + `<div class="col-md-3"><select class="form-select" id="adAccountList_${index}" name="adAccountList_${index}"><option value="">-- 광고 계정 ${index + 1} --</option></select></div>` // index 사용
                + `<div class="col-md-3"><select class="form-select" id="campaignList_${index}" name="campaignList_${index}"><option value="">-- 캠페인 ${index + 1} --</option></select></div>` // index 사용
                + `<div class="col-md-3"><select class="form-select" id="pixelList_${index}" name="pixelList_${index}"><option value="">-- 픽셀 ${index + 1} --</option></select></div>`       // index 사용
                + `<div class="col-md-3"><select class="form-select" id="setList_${index}" name="setList_${index}"><option value="">-- 세트 ${index + 1} --</option></select></div>`             // index 사용
                + '</div>';

        // 옵션 추가 시 index 사용 (createElement 사용 권장하지만 일단 innerHTML 유지)
        const adAccountSelect = document.getElementById(`adAccountList_${index}`);
        if (adAccountSelect) {
          currentAdAccountList.forEach(a => {
            // 주의: value에 특수문자가 있으면 문제가 될 수 있음. createElement가 더 안전함.
            adAccountSelect.innerHTML += `<option value="${a.id}">${a.name}</option>`;
          });
        }

        const campaignSelect = document.getElementById(`campaignList_${index}`);
        if (campaignSelect) {
          currentCampaignList.forEach(c => {
            campaignSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
          });
        }

        const pixelSelect = document.getElementById(`pixelList_${index}`);
        if (pixelSelect) {
          currentPixelList.forEach(p => {
            pixelSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
          });
        }

        const setSelect = document.getElementById(`setList_${index}`);
        if (setSelect) {
          currentSetList.forEach(s => {
            setSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
          });
        }
      }); // forEach 루프 끝

      // 모달 열기
      new bootstrap.Modal(document.querySelector('#exampleModal')).show();
    }



    // metaSubmit 함수를 async 함수로 변경
    async function metaSubmit() {
      const allRowData = gridApi.getGridOption("rowData");
      if (!allRowData || allRowData.length === 0) {
        alert("전송할 데이터가 없습니다.");
        return;
      }

      // --- 전체 처리 시작 전 UI 업데이트 (예: 버튼 비활성화) ---
      const submitButton = document.querySelector('button[onclick="metaSubmit()"]');
      if (submitButton) submitButton.disabled = true;
      console.log("순차적 광고 등록 시작...");
      // 필요하다면 전체 진행률 표시기 표시

      let successCount = 0;
      let errorCount = 0;


      for (const [rowIndex, rowData] of allRowData.entries()) {
        console.log(`Row ${rowIndex + 1} 처리 시작...`);

        try { // 각 행 처리 시 발생할 수 있는 오류를 잡기 위해 try...catch 사용
          // --- 현재 행 데이터 준비 ---
          const newRow = { ...rowData }; // 원본 데이터 복사

          // 모달에서 선택된 값 가져오기
          const selectedAdAccountIdForRow = document.getElementById(`adAccountList_${rowIndex}`)?.value;
          const selectedCampaignIdForRow = document.getElementById(`campaignList_${rowIndex}`)?.value;
          const selectedPixelIdForRow = document.getElementById(`pixelList_${rowIndex}`)?.value;
          const selectedSetIdForRow = document.getElementById(`setList_${rowIndex}`)?.value;

          // 선택값 적용
          newRow.adAccountId = selectedAdAccountIdForRow || newRow.adAccountId;
          newRow.campaignId = selectedCampaignIdForRow || newRow.campaignId;
          newRow.pixelId = selectedPixelIdForRow || newRow.pixelId;
          newRow.setId = selectedSetIdForRow || newRow.setId;

          // AdRequestDto 생성
          const requestBody = new AdRequestDto({
            index: rowIndex + 1, // 1부터 시작하는 인덱스
            // DTO 생성자에 필요한 모든 필드를 newRow에서 가져와 전달
            adAccountId: newRow.adAccountId,
            adAccountName: newRow.adAccountName,
            metaCampaignObjective: newRow.metaCampaignObjective,
            metaCampaignType: newRow.metaCampaignType,
            campaignName: newRow.campaignName,
            campaignId: newRow.campaignId,
            budget: newRow.budget,
            ageRange: newRow.ageRange,
            startDate: newRow.startDate,
            startTime: newRow.startTime,
            location: newRow.location,
            language: newRow.language,
            gender: newRow.gender,
            minAge: newRow.minAge,
            maxAge: newRow.maxAge,
            setName: newRow.setName,
            setId: newRow.setId,
            adMaterialName: newRow.adMaterialName,
            pageId: newRow.uploadPage, // pageId 필드가 uploadPage 값을 사용하는지 확인 필요
            metaCreativeFormat: newRow.metaCreativeFormat,
            landingUrl: newRow.landingUrl,
            displayUrl: newRow.displayUrl,
            defaultText: newRow.defaultText,
            title: newRow.title,
            description: newRow.description,
            otherRequests: newRow.otherRequests,
            blank: newRow.blank,
            adCode: newRow.adCode,
            isShortUrlCreate: newRow.isShortUrlCreate,
            shortUrl: newRow.shortUrl,
            pixelId: newRow.pixelId,
            uploadPageName: newRow.uploadPage, // uploadPageName 필드 추가 (DTO에 있다면)
            // Resolved 필드는 DTO 기본값(false) 사용
          });

          const requestJson = JSON.stringify(requestBody);
          const formData = new FormData();

          // --- 현재 행의 파일 추가 ---
          // 주의: DOM에서 특정 행의 파일 입력을 안정적으로 찾는 방법 필요
          // getRowNode 사용 시도 (rowNode가 null일 수 있음에 유의)
          const rowNode = gridApi.getRowNode(rowIndex);
          let fileInput = null;
          if (rowNode?.eGui) { // 행의 DOM 요소가 렌더링된 경우
            fileInput = rowNode.eGui.querySelector('input[type="file"][name="files"]');
          } else {
            // Fallback: DOM 요소가 없을 경우 (예: 가상 스크롤)
            // 이 방식은 DOM 순서와 데이터 순서가 일치한다고 가정하므로 덜 안정적일 수 있음
            console.warn(`Row node for index ${rowIndex} not found directly. Using querySelectorAll as fallback.`);
            const allFileInputs = document.querySelectorAll('#myGrid input[type="file"][name="files"]');
            if (allFileInputs.length > rowIndex) {
              fileInput = allFileInputs[rowIndex];
            }
          }

          let filesAttached = false;
          if (fileInput && fileInput.files && fileInput.files.length > 0) {
            for (let j = 0; j < fileInput.files.length; j++) {
              formData.append('files', fileInput.files[j]);
              filesAttached = true;
            }
            console.log(`Row ${rowIndex + 1}: ${fileInput.files.length} files attached.`);
          } else {
            console.log(`Row ${rowIndex + 1}: No files attached.`);
          }

          // JSON 데이터를 Blob으로 추가
          const blob = new Blob([requestJson], { type: 'application/json' });
          formData.append('request', blob, 'request.json');
          await fetchCall(formData);
          successCount++;
          rowNode?.setDataValue('errorMessage', 'SUCCESS');//버튼 success
        } catch (error) {
          errorCount++;
          const rowNode = gridApi.getRowNode(rowIndex); // 다시 노드 찾기
          if (rowNode) {
            // 서버 응답 오류 메시지를 파싱하여 넣거나, 일반 오류 메시지 사용
            let errMsg = error.message || "알 수 없는 오류";
            rowNode.setDataValue('errorMessage', errMsg);
            try {
              // 예시: error.message가 "HTTP error! status: 400, message: {"error":...}" 형태일 경우
              const jsonStartIndex = errMsg.indexOf('{');
              if (jsonStartIndex !== -1) {
                const jsonString = errMsg.substring(jsonStartIndex);
                const errorData = JSON.parse(jsonString);
                const userTitle = errorData?.error?.error_user_title;
                const userMsg = errorData?.error?.error_user_msg;
                if (userTitle && userMsg) {
                  errMsg = `제목: ${userTitle}\n\n내용: ${userMsg}`;
                } else if (errorData?.error) {
                  errMsg = JSON.stringify(errorData.error, null, 2);
                }
              }
            } catch (parseError) { /* 파싱 실패 시 기존 errMsg 사용 */ }

            rowNode.setDataValue('errorMessage', errMsg);
          }
          // 루프를 계속 진행 (오류 발생해도 다음 행 처리)
          // 만약 오류 발생 시 중단하려면 여기서 throw error; 또는 return;
        }
      } // for 루프 끝

      // --- 전체 처리 완료 후 UI 업데이트 ---
      if (submitButton) submitButton.disabled = false;
      console.log(`순차적 광고 등록 완료. 성공: ${successCount}, 실패: ${errorCount}`);
      alert(`전체 광고 등록 시도 완료.\n성공: ${successCount}건\n실패: ${errorCount}건`);
      // 필요하다면 전체 진행률 표시기 숨김

      // 모든 처리가 끝난 후 모달 닫기
      const modalElement = document.getElementById('exampleModal');
      const bootstrapModal = bootstrap.Modal.getInstance(modalElement);
      if (bootstrapModal) {
        bootstrapModal.hide();
      }
    }
      function fetchCall(formData) {
        const headerValues = {
          'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.getAttribute('content')
        };
        fetchWithSpinner(
                '/api/meta/publish',
                {
                  headers: headerValues,
                  method: 'POST',
                  body: formData,
                },
                "rowProcessing",
                false,
                "광고업로드 성공!",
                "광고업로드 실패.."
        )
                .then(response => {
                  if (!response.ok) {
                    return response.text().then(text => {
                      let errorMessage = `HTTP error! status: ${response.status}`;
                      try {
                        // 서버가 JSON 형태의 에러 메시지를 보냈을 경우 파싱 시도
                        const errorData = JSON.parse(text);
                        errorMessage += `, message: ${errorData.message || errorData.error || text}`;
                      } catch (e) {
                        // JSON 파싱 실패 시 그냥 텍스트 사용
                        errorMessage += `, message: ${text}`;
                      }
                      throw new Error(errorMessage);
                    });
                  }

                  return response.json();
                })
                .then(data => {
                  console.log('Upload success:', data);
                  // 성공 시 처리 로직 (예: 그리드 업데이트, 알림 표시 등)
                  alert('데이터 및 파일 전송 성공!');
                  // 필요하다면 성공 후 그리드 초기화 또는 상태 업데이트
                  // gridApi.setGridOption('rowData', []); // 예시: 성공 후 그리드 비우기
                })
                .catch(error => {
                  console.error('Upload error:', error);
                  // 에러 시 처리 로직 (예: 사용자에게 에러 알림)
                  alert(`데이터 및 파일 전송 중 오류 발생: ${error.message}`);
                });
      }


    // --- 상태 버튼 렌더러 컴포넌트 ---
    // --- 상태 버튼 렌더러 컴포넌트 ---
    class StatusButtonRenderer {
      // ... (eGui, eButton, errorMessage 등 선언 동일) ...
      errorModalInstance = null;

      init(params) {
        this.eGui = document.createElement('div');
        this.eButton = document.createElement('button');
        this.eButton.type = 'button';
        this.eButton.classList.add('btn', 'btn-sm');
        this.errorMessage = params.value; // 현재 행의 errorMessage 값

        // 모달 인스턴스 가져오기 (동일)
        const errorModalElement = document.getElementById('errorDetailModal');
        if (errorModalElement) {
          this.errorModalInstance = bootstrap.Modal.getOrCreateInstance(errorModalElement);
        } else {
          console.error("Error modal element (#errorDetailModal) not found!");
        }
        // --- 상태 분기 로직 수정 ---
        if (this.errorMessage === 'SUCCESS') {
          // 1. 전송 완료 상태
          this.eButton.classList.add('btn-success'); // 녹색 버튼
          this.eButton.textContent = '전송완료';
          this.eButton.disabled = true;
        } else if (this.errorMessage != null && this.errorMessage !== '') {
          // 2. 오류 발생 상태 (null, 빈 문자열, '__SUCCESS__'가 아님)
          this.eButton.classList.add('btn-warning'); // 주황색 버튼 (또는 btn-danger)
          this.eButton.textContent = '오류 보기';
          this.eButton.disabled = false; // 활성화 (클릭 가능)

          // 오류 보기 모달 리스너 (기존 로직과 동일)
          this.eventListener = () => {
            if (this.errorModalInstance && this.errorMessage) {
              const modalBody = document.getElementById('errorDetailModalBody');
              const codeElement = modalBody?.querySelector('pre > code');
              if (codeElement) {
                let displayMessage = this.errorMessage;
                try {
                  const errorData = JSON.parse(this.errorMessage);
                  const errorObject = errorData?.error;
                  const userTitle = errorObject?.error_user_title;
                  const userMsg = errorObject?.error_user_msg;
                  if (userTitle && userMsg) {
                    displayMessage = `제목: ${userTitle}\n\n내용: ${userMsg}`;
                  } else if (errorObject) {
                    displayMessage = JSON.stringify(errorObject, null, 2);
                  }
                } catch (e) {
                  console.warn("Could not parse errorMessage as JSON, displaying original message:", e);
                }
                codeElement.textContent = displayMessage;
              } else {
                console.error("Modal body's code element not found!");
                if(modalBody) modalBody.textContent = this.errorMessage;
              }
              this.errorModalInstance.show();
            } else if (!this.errorModalInstance) {
              console.error("Cannot show error modal because the instance is not available.");
              alert(`오류 내용:\n${this.errorMessage}`);
            }
          };
          this.eButton.addEventListener('click', this.eventListener);

        } else {
          this.eButton.classList.add('btn-primary'); // 파란색 버튼
          this.eButton.textContent = '정상';
          this.eButton.disabled = true; // 비활성화
        }


        this.eGui.appendChild(this.eButton);
      }

      getGui() {
        return this.eGui;
      }

      refresh(params) {
        // refresh 시에도 errorMessage 업데이트 및 버튼 상태 재설정 필요 시 로직 추가
        this.errorMessage = params.value;
        // 간단하게는 false 반환하여 재생성 유도
        return false;
      }

      destroy() {
        if (this.eButton && this.eventListener) {
          this.eButton.removeEventListener('click', this.eventListener);
        }
        // 모달 인스턴스 자체를 destroy 할 필요는 없음 (공용 모달이므로)
      }
    }


      class CustomButtonComponent {
        eGui;
        eButton;
        eventListener;

        init() {
          this.eGui = document.createElement("div");
          const eButton = document.createElement("input");
          eButton.setAttribute("type", "file");
          eButton.setAttribute("name", "files");
          eButton.setAttribute("class", "form-control");
          eButton.setAttribute("multiple", "multiple");
          eButton.setAttribute("accept", ".jpg, .jpeg, .png, .mp4, .gif");
          eButton.textContent = "파일 업로드";
          this.eGui.appendChild(eButton);
        }

        getGui() {
          return this.eGui;
        }

        refresh() {
          return true;
        }

        destroy() {
          if (this.eButton) {
            this.eButton.removeEventListener("click", this.eventListener);
          }
        }
      }

      const gridOptions = {

        rowData: [],

        columnDefs: [
          {
            headerName: "상태",
            field: "errorMessage",
            cellRenderer: StatusButtonRenderer,
            minWidth: 120, maxWidth: 300
          },
          {
            headerName: "파일 업로드",
            field: "button",
            cellRenderer: CustomButtonComponent,
            minWidth: 280
          },
          {
            headerName: "캠페인 목표(선택)",
            field: "metaCampaignObjective",
            editable: true,
            cellEditor: "agSelectCellEditor",
            cellEditorParams: {
              values: [
                "판매",
                "트래픽"
              ],
            },
            minWidth: 150, maxWidth: 300,
            valueFormatter: params => {
              const value = params.value;
              if (value === 'OUTCOME_SALES') {
                return '판매';
              } else if (value === 'OUTCOME_TRAFFIC') {
                return '트래픽';
              } else {
                return value;
              }
            },
            valueSetter: params => {
              const selectedText = params.newValue;
              const field = params.colDef.field;
              const data = params.data;

              if (selectedText === '판매') {
                data[field] = 'OUTCOME_SALES';
              } else if (selectedText === '트래픽') {
                data[field] = 'OUTCOME_TRAFFIC';
              } else {
                // 예외 처리: 예상치 못한 값이 선택된 경우
                data[field] = selectedText;
              }
              return true;
            }
          },
          {
            headerName: "캠페인 형태(선택)",
            field: "metaCampaignType",
            editable: true,
            cellEditor: "agSelectCellEditor",
            cellEditorParams: {
              values: [
                "ABO",
                "ASC",
                "CBO",
              ],
            },
            minWidth: 150, maxWidth: 300
          },
          {
            headerName: "형식(선택)",
            field: "metaCreativeFormat",
            editable: true,
            cellEditor: "agSelectCellEditor",
            cellEditorParams: {
              values: [
                "단일 이미지·동영상",
                "슬라이드",
              ],
            },
            minWidth: 150, maxWidth: 300
          },
          {
            headerName: "광고 계정명",
            field: "adAccountName",
            minWidth: 150, maxWidth: 300
          },

          {
            headerName: "캠페인명",
            field: "campaignName",
            minWidth: 150, maxWidth: 300
          },
          {
            headerName: "예산",
            field: "budget",
            editable: true, // 편집 기능 유지
            minWidth: 150, maxWidth: 300,
            // --- 원화 포맷터 추가 ---
            valueFormatter: params => {
              // 값이 null, undefined 또는 숫자가 아니면 빈 문자열 반환
              if (params.value == null || isNaN(params.value)) {
                return '';
              }
              // Intl.NumberFormat을 사용하여 한국 원화 형식으로 변환
              try {
                return new Intl.NumberFormat('ko-KR', {
                  style: 'currency',
                  currency: 'KRW'
                  // 소수점이 필요 없으면 아래 주석 해제
                  // minimumFractionDigits: 0,
                  // maximumFractionDigits: 0
                }).format(params.value);
              } catch (e) {
                console.error("Error formatting currency:", e, "Value:", params.value);
                return params.value; // 포맷팅 실패 시 원본 값 반환 (또는 다른 처리)
              }
            },
            // --- (선택 사항) 타입 지정 ---
            // 정렬, 필터링 등을 위해 숫자 타입으로 명시하는 것이 좋습니다.
            type: 'numericColumn'
          },
          {
            headerName: "나이 범위(설정시 어드밴티지 + 타겟 활성화)",
            field: "ageRange",
            editable: true,
            minWidth: 277, maxWidth: 300
          },
          {
            headerName: "시작날짜(선택)",
            field: "startDate",
            editable: true,
            minWidth: 150, maxWidth: 300
          },
          {
            headerName: "시작 시간",
            field: "startTime",
            chartDataType: 'time',
            editable: true,
            minWidth: 150, maxWidth: 300
          },
          {
            headerName: "위치(선택)",
            field: "location",
            editable: true,
            cellEditor: "agSelectCellEditor",
            minWidth: 100, maxWidth: 300,
            cellEditorParams: {
              values: [
                "대한민국",
                "일본",
              ],
            },
          },
          {
            headerName: "언어(선택)",
            field: "language",
            editable: true,
            cellEditor: "agSelectCellEditor",
            minWidth: 100, maxWidth: 300,
            cellEditorParams: {
              values: [
                "한국어",
                "일본어",
              ],
            },
          },
          {
            headerName: "성별(선택)",
            field: "gender",
            editable: true,
            cellEditor: "agSelectCellEditor",
            minWidth: 100, maxWidth: 300,
            cellEditorParams: {
              values: [
                "모든 성별",
                "남",
                "여",
              ],
            },
          },
          {
            headerName: "최소 연령",
            field: "minAge",
            minWidth: 100, maxWidth: 300
          },
          {
            headerName: "최대 연령",
            field: "maxAge",
            minWidth: 100, maxWidth: 300
          },
          {
            headerName: "세트명",
            field: "setName",
            minWidth: 150, maxWidth: 300
          },
          {
            headerName: "광고소재명",
            field: "adMaterialName",
            minWidth: 150, maxWidth: 300
          },
          {
            headerName: "업로드 페이지명",
            field: "uploadPage",
            minWidth: 150, maxWidth: 300
          },

          {
            headerName: "랜딩페이지 URL",
            field: "landingUrl",
            editable: true,
            minWidth: 150, maxWidth: 300
          },
          {
            headerName: "표시링크 URL",
            field: "displayUrl",
            editable: true,
            minWidth: 100, maxWidth: 300
          },
          {
            headerName: "기본 문구",
            field: "defaultText",
            editable: true,
            minWidth: 100, maxWidth: 300
          },
          {
            headerName: "제목",
            field: "title",
            editable: true,
            minWidth: 100, maxWidth: 300
          },
          {
            headerName: "설명",
            field: "description",
            editable: true,
            minWidth: 100, maxWidth: 300
          },
          {
            headerName: "기타 요청사항",
            field: "otherRequests",
            editable: true,
            minWidth: 100, maxWidth: 300
          },

        ],

        rowClassRules: {
          // apply red to Ford cars
          "rag-green": (params) => params.data.agSelectCellEditor === "ASC",
        },
        /*rowData: getData(), 이거로 불러서 데이터 뿌려주기*/
        autoSizeStrategy: {
          type: "fitGridWidth",
        },
        onGridReady: (params) => {
          minRowHeight = params.api.getSizesForCurrentTheme().rowHeight;
          currentRowHeight = minRowHeight;
        },

        getRowHeight: (params) => {
          return currentRowHeight;
        },
      };


      document.addEventListener("DOMContentLoaded", function () {

        const gridDiv = document.querySelector("#myGrid");
        // gridApi를 여기서 초기화합니다.
        gridApi = agGrid.createGrid(gridDiv, gridOptions);

        const Input = document.getElementById('excelInput');
        const uploadButton = document.getElementById('uploadButton');
        let selectedFile;

        Input.addEventListener('change', function (event) {
          selectedFile = event.target.files[0];
          // (선택 사항) 파일이 선택되면 버튼 활성화 등의 로직 추가 가능
          if (selectedFile) {
            console.log("파일 선택됨:", selectedFile.name);
            // uploadButton.disabled = false; // 예시: 버튼 활성화
          }
        });

        // 업로드 버튼 클릭 시 실행될 로직
        uploadButton.addEventListener('click', function () {
          // 파일이 선택되었는지 확인
          if (!selectedFile) {
            alert('업로드할 엑셀 파일을 먼저 선택해주세요.');
            return;
          }

          const formData = new FormData();
          formData.append('file', selectedFile);

          const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
          const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
          let headerValues = {};
          if (csrfHeader && csrfToken) {
            headerValues[csrfHeader] = csrfToken;
          }

          console.log("파일 업로드 시작...");
          gridApi.showLoadingOverlay();
          document.getElementById('uploadButton').disabled = true;
          fetchWithSpinner(
                  '/api/meta/upload',
                  {
                    headers: headerValues,
                    method: 'POST',
                    body: formData
                  },
                  "excelSaving",
                  true, // JSON 파싱
                  "엑셀 업로드 성공!", // 성공 메시지
                  "엑셀 업로드 실패" // 실패 메시지
          )
                  .then(resData => {
                    console.log("업로드 성공 및 데이터 수신:", resData);
                    if (gridApi && resData) {


                      gridApi.setGridOption('rowData', resData.data);
                    } else {
                      console.warn("gridApi가 초기화되지 않았거나 받은 데이터가 없습니다.");
                      document.getElementById('uploadButton').disabled = false;
                    }

                    gridApi.hideOverlay();
                  })
                  .catch(error => {
                    // 에러 처리
                    console.error("파일 업로드 또는 처리 중 에러 발생:", error);
                    alert(`파일 업로드 중 오류가 발생했습니다: ${error.message}`);
                    gridApi.hideOverlay();
                    document.getElementById('uploadButton').disabled = false;
                  });
        });
      }); // DOMContentLoaded listener 끝
      class AdRequestDto {
        constructor(data = {}) {
          this.index = data.index || null;
          this.metaCampaignObjective = data.metaCampaignObjective || null;
          this.metaCampaignType = data.metaCampaignType || null;
          this.adAccountName = data.adAccountName || null;
          this.adAccountId = data.adAccountId || null;
          this.pixelId = data.pixelId || null;
          this.campaignName = data.campaignName || null;
          this.campaignId = data.campaignId || null;
          this.budget = data.budget || null;
          this.ageRange = data.ageRange || null;
          this.startDate = data.startDate || null;
          this.startTime = data.startTime || null;
          this.location = data.location || null;
          this.language = data.language || null;
          this.gender = data.gender || null;
          this.minAge = data.minAge || null;
          this.maxAge = data.maxAge || null;
          this.setName = data.setName || null;
          this.setId = data.setId || null;
          this.adMaterialName = data.adMaterialName || null;
          this.uploadPageName = data.uploadPageName || null;
          this.pageId = data.pageId || null;
          this.metaCreativeFormat = data.metaCreativeFormat || null;
          this.landingUrl = data.landingUrl || null;
          this.displayUrl = data.displayUrl || null;
          this.defaultText = data.defaultText || null;
          this.title = data.title || null;
          this.description = data.description || null;
          this.otherRequests = data.otherRequests || null;
          this.blank = data.blank || null;
          this.adCode = data.adCode || null;
          this.isShortUrlCreate = data.isShortUrlCreate || null;
          this.shortUrl = data.shortUrl || null;
          this.pageResolved = false;
          this.adAccountResolved = false;
          this.campaignResolved = false;
          this.setResolved = false;
          this.pixelResolved = false;
        }
      }


  </script>
  <th:block layout:fragment="script">

  </th:block>
</div>
</body>

</html>
